<%inherit file="/main.html" />
<%namespace file="/defs.html" name="defs" import="*"/>
<%def name="title()">${c.node.title}</%def>
<%def name="adds_head()"></%def>
<script type="text/javascript">
/* <![CDATA[ */
    $(document).ready(function(){
        $('.event-show .title').hover(
            function() {
                $(this).find('.node-actions').slideDown('fast');
            },
            function() {
                $(this).find('.node-actions').slideUp('fast');
            }
        );
        $('.event-reports .title').hover(
            function() {
                $(this).find('.node-actions').slideDown('fast');
            },
            function() {
                $(this).find('.node-actions').slideUp('fast');
            }
        );
        $('.event-persons .avatar').hover(
            function() {
                $(this).find('.node-actions').slideDown('fast');
            },
            function() {
                $(this).find('.node-actions').slideUp('fast');
            }
        );
        $('.event-albums .gallery').each(function() {
            var gallery = $(this)
            var actions = gallery.parent('.node').find('.node-actions')
            gallery.append(actions.clone(true))
            actions.remove()
            gallery.hover(
                function() {
                    $(this).find('.node-actions').slideDown('fast');
                },
                function() {
                    $(this).find('.node-actions').slideUp('fast');
                }
            );
        })

        $('a.on_page').click(
            function() {
                if ($(this).hasClass('confirm') && !confirm(this.rel)) {
                    return false
                }

                $('#modal-container div').html(
                    '<div class="box-error">загрузка...</div>'
                );
                var link = this;

                $.ajax({
                    url: this.href,
                    data: {on_page:1},
                    beforeSend: function(){
                        $('#informer').html('');
                        $('#loader').show();
                    },
                    complete: function (xhr, type)  {
                        if(type !== "success"){
                            $('#loader').hide();
                        }
                    },
                    success: function(data){
                        if ($(link).hasClass('modal')) {
                            $('#loader').hide();
                            $.fn.colorbox({
                                open: true,
                                inline: true,
                                href: link.rev,
                                opacity: 0.5,
                                title: " ",
                                height: '500px',
                                width: '450px'
                            });
                        }
                    }
                });
                return false;
            }
        );
    });
/* ]]> */
</script>
<div class="event-show">
    <div id="loader" class="loading hide"></div>
    <div class="title">
        <h1>${self.title()}</h1>
        % if h.is_node_owner(c.node):
            <div class="box-actions">
                <a href="${c.node.url_edit()}" class="on_page modal" rev="#event-edit" title="Изменить иформацию о событии">Изменить</a>
                <div class="node-actions">
                    % if not c.node.published:
                        <a href="${c.node.url_publish()}" class="on_page">Опубликовать</a>
                    %else:
                        <a href="${c.node.url_publish(False)}" class="on_page">В черновики</a>
                    % endif
                    % if c.node.id != 1 :
                    <a href="${c.node.url_remove()}" class="on_page confirm" rel="Точно хотите удалить?">Удалить</a>
                    % endif
                </div>
            </div>
        % endif
    </div>
    <div class="title-info">
        ${defs.node_info(c.node, True)}
    </div>

    <div class="container">

        <div class="span-60">
            <div class="box">
                ${defs.event_details(c.node)}
            </div>

            <div class="box">
                <div class="box-title">Отчеты</div>
                % if h.is_node_owner(c.node):
                    <div class="box-actions border">
                        <a href="${c.node.url_add_report()}">Добавить</a>
                    </div>
                % endif
                ${defs.event_reports(c.node, True)}
            </div>
        </div>

        <div class="span-40">
            <div class="box">
                <div class="box-title">
                    Участники
                </div>
                % if h.is_node_owner(c.node):
                    <div class="box-actions border">
                        <a href="${c.node.url_add_person()}" class="on_page modal" rev="#person-new">Добавить</a>
                    </div>
                % endif
                <div class="event-persons container">
                    % if 0 == len(c.node.persons):
                       <div class="box-empty">
                           Участников нет.
                           % if h.is_node_owner(c.node):
                               Но можно <a href="${c.node.url_add_person()}" class="on_page modal" rev="#person-new">добавить</a>.
                           % endif
                       </div>
                    % endif

                    % for person in c.node.persons:
                    <div class="span-50"><div class="node avatar">
                        <a title="${person.fullname}">
                        <div class="avatar-img" style="background: #333 url(${person.url_avatar(with_time=True)}) no-repeat center;"></div>
                        <div class="avatar-info">${person.fullname}</div>
                        </a>
                        % if h.is_node_owner(c.node):
                            <div class="node-actions">
                                <a href="${person.url_edit()}" class="on_page modal" rev="#person-edit">Изменить</a>
                                <a href="${person.url_remove()}" class="on_page confirm" rel="Точно хотите удалить?">Удалить</a>
                            </div>
                       % endif
                    </div></div>
                    % endfor
                </div>
            </div>
            <div class="box">
                <div class="box-title">Альбомы</div>
                % if h.is_node_owner(c.node):
                    <div class="box-actions border">
                        <a href="${c.node.url_add_album()}" class="on_page modal" rev="#album-new">Добавить</a>
                    </div>
                % endif
                <div class="event-albums">
                    % if 0 == len(c.node.albums):
                       <div class="box-empty">
                           Альбомов нет.
                           % if h.is_node_owner(c.node):
                               Но можно <a href="${c.node.url_add_album()}" class="on_page modal" rev="#album-new">добавить</a>.
                           % endif
                       </div>
                    % endif

                    % for album in c.node.albums:
                    <div class="node">
                        ${h.picasa.render(album.settings, count_per_page=2)}
                        <div class="node-actions">
                            <a href="${album.url_to_picasa()}" title="Посмотреть в Picasa" target="_blank"><span class="picasa">Picasa</span></a>
                            % if h.is_node_owner(c.node):
                                <a href="${album.url_reload(event_id=c.node.id)}" class="on_page">Обновить</a>
                                <a href="${album.url_remove(event_id=c.node.id)}" class="on_page confirm" rel="Точно хотите удалить?">Удалить</a>
                           % endif
                       </div>
                    </div>
                    % endfor

                    ##<div class="node">
                    ##${h.picasa.render_by_user('naspeh', 'Naspeh', limit=2, count_per_page=2)}
                    ##</div>

                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal-container" class="hide">
    <div id="event-edit"></div>
    <div id="person-edit"></div>
    <div id="person-new"></div>
    <div id="album-new"></div>
</div>
